#!/home/pipeline-stable/.conda/envs/pipeline/bin/python
"""
Clear Completed Schedules

Script to clear completed schedules from the scheduler database.
Designed to be run periodically via systemd timer.
"""

import sys
from pathlib import Path

# Add pipeline to path
pipeline_dir = Path(__file__).parent.parent.parent
sys.path.insert(0, str(pipeline_dir))

from pipeline.services.scheduler import Scheduler
from pipeline.const import SCHEDULER_DB_PATH


def main():
    """Main entry point."""
    if not SCHEDULER_DB_PATH:
        print("ERROR: SCHEDULER_DB_PATH environment variable not set", file=sys.stderr)
        sys.exit(1)

    try:
        scheduler = Scheduler(use_system_queue=True)
        scheduler.rerun_failed_tasks()
        print(f"Successfully rerun failed tasks")
        sys.exit(0)
    except Exception as e:
        print(f"ERROR: Failed to rerun failed tasks: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
