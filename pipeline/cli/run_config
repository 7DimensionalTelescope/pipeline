#!/home/pipeline-stable/.conda/envs/pipeline/bin/python

import argparse
import sys
import signal

from pipeline.services.scheduler import Scheduler


def signal_handler(sig, frame):
    print("\nTerminate process")
    sys.exit(0)


signal.signal(signal.SIGINT, signal_handler)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Run pipeline processing for one or more config files using the system queue.",
        epilog=(
            "Examples:\n"
            "  %(prog)s /path/to/config1.yml\n"
            "  %(prog)s /path/to/config1.yml /path/to/config2.yml /path/to/config3.yml"
        ),
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    parser.add_argument(
        "configs",
        nargs="+",
        help="Path(s) to config file(s) to process (one or more)",
    )
    parser.add_argument(
        "--priority",
        type=int,
        default=10,
        help="Base priority for scheduled jobs (default: 10)",
    )
    parser.add_argument(
        "--overwrite",
        action="store_true",
        help="Overwrite all outputs (preprocess and science)",
    )
    parser.add_argument(
        "--overwrite-data",
        action="store_true",
        help="Overwrite pipeline data outputs (same as --overwrite for from_list)",
    )
    parser.add_argument(
        "--overwrite-preprocess",
        action="store_true",
        help="Overwrite preprocess outputs only",
    )
    parser.add_argument(
        "--overwrite-science",
        action="store_true",
        help="Overwrite science outputs only",
    )
    parser.add_argument(
        "--overwrite-schedule",
        action="store_true",
        help="Overwrite existing schedule in the database",
    )
    args = parser.parse_args()

    try:
        sc = Scheduler.from_list(
            args.configs,
            base_priority=args.priority,
            use_system_queue=True,
            overwrite_schedule=args.overwrite_schedule,
            overwrite=args.overwrite,
            overwrite_data=args.overwrite_data,
            overwrite_preprocess=args.overwrite_preprocess,
            overwrite_science=args.overwrite_science,
        )
        sc.start_system_queue()
    except Exception as e:
        print(f"\nError: {e}")
        sys.exit(1)
